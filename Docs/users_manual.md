---
title: "Руководство пользователя"
author: "Система диагностики приемного тракта ИРНР"
date: "2025-06-27"
subject: "Markdown"
keywords: [Markdown, Example]
lang: "ru"
titlepage: true
titlepage-background: box.jpg
titlepage-text-color: 101010
toc: true
toc-own-page: true
fontfamily: dejavu
#fontfamilyoptions: default (opensans)
header-includes: |
	\usepackage[utf8]{inputenc}
	\usepackage[T2A]{fontenc}
	\renewcommand{\familydefault}{\sfdefault}	
	\let\oldsection\section
	\renewcommand{\section}{\clearpage\oldsection}

...

# Введение

Данный документ содержит описание компонентов в составе системы диагностики приемного тракта ИРНР, включая программируемый генератор сигналов ("калибратор") а также сопутствующие утилиты управления и анализа данных, и рассматривает подходы к проведению измерений.

- В первом разделе содержится техническая документация к генератору сигналов, включая описание физических интерфейсов, принципиальную схему и протоколы сетевого взаимодействия.
- Во втором разделе дано описание утилит управления и анализа данных.
- В третьем разделе описываются подходы к проведению диагностических измерений с использованием системы.

# Генератор тестовых сигналов

Генератор сигналов выполнен в виде устанавливаемого в стойку блока и построен на основе микроконтроллера STM32F746 и цифрового синтезатора сигналов AD9910.

## Интерфейсы на задней и передней панели

![Схема интерфейсов на задней и передней панели](Images/physical_interfaces.drawio.pdf)

> Для включения генератора сигналов нужно предоставить **питание и опорный тактовый сигнал,** частота которого составляет 25 МГц, а уровень равен 500 мВ.

Индикатор питания загорается зеленым, когда питание генератора сигналов включено (выключатель питания находится в положении "вверх") и опорный тактовый сигнал поступает. При пропадании опорного тактового сигнала индикатор питания потухнет.

В случае пропадания опорного тактового сигнала генератор производит перезагрузку и ожидает появления тактового сигнала.

Индикатор излучения загорается желто-зеленым, когда запущено воспроизведение и генератор ожидает очередное триггерное событие, чтобы излучить следующий импульс из очереди сигналов. Индикатор излучения также загорается, когда генератор излучает в непрерывном режиме.

## Протокол сетевого взаимодействия

> Для управления генератором сигналов его нужно подключить к локальной сети через интерфейс Ethernet. Генератор сигналов присваивает себе фиксированный **IP-адрес 192.168.0.12;** проверить доступность генератора сигналов в локальной сети можно путём отправки ping-запросов при помощи утилиты ping.

Взаимодействие с генератором сигналов происходит посредством протокола TCP. Управление осуществляется при помощи текстовых команд в интерактивном интерфейсе командной строки. Возможно управление как в ручном режиме, так и при помощи утилит, частично автоматизирующих процесс (будут рассмотрены далее.)

Чтобы подключиться к генератору для управления вручную, необходимо воспользоваться утилитой netcat (Linux) либо putty (Windows). Подключение осуществляется на порт 80. После подключения выводится приветствие и приглашение ввода команды.

В выбранный момент времени возможно только одно подключение к генератору сигналов. Генератор отказывает в принятии дополнительных подключений. Программа, открывшая подключение, становится исключительным владельцем генератора на время жизни подключения.

Далее рассмотрена система команд генератора.

**СОЗДАНИЕ СИГНАЛОВ**

|**Команда**|**Пояснение**|
|---|---|
|rfkill|Прекратить излучение|
|set_level [value] [unit]|Задать уровень сигналов в вольтах (rms), напр. `set_level 270 mV`; действует только на новые сигналы|
|dbg_level [asf] [fsc]|Напрямую задать уровень сигналов в машинных кодах синтезатора, напр. `dbg_level 16383 255`; действует только на новые сигналы|
|test_tone [freq] [unit]|Подавать непрерывный сигнал на указанной частоте, напр. `test_tone 158 MHz`|
|basic_pulse [delay] [unit] [duration] [unit] [freq] [unit]|Подавать импульсы с указанной задержкой, длительностью и частотой, напр. `basic_pulse 1200 us 900 us 158 MHz`|
|basic_sweep [delay] [unit] [duration] [unit] [center_freq] [unit] [a] [b]|Подавать ЛЧМ сигналы с указанной задержкой, длительностью, центральной частотой и полосой, напр. `basic_sweep 1200 us 900 us 158 MHz 77 1`|

> Примечание 1: частоты и время можно указывать со знаками после запятой (точки) и в разных единицах (us, ns, Hz, kHz, MHz)

> Примечание 2: команды basic_pulse и basic_sweep сбрасывают очередь сигналов; они предоставляют возможности по немедленному созданию сигналов и предназначены прежде всего для проверки генератора в интерактивном режиме, а не для измерений.

**УПРАВЛЕНИЕ ОЧЕРЕДЬЮ СИГНАЛОВ**

|**Команда**|**Пояснение**|
|---|---|
|seq run|Запустить воспроизведение|
|seq stop|Остановить воспроизведение|
|seq reset|Очистить очередь|
|seq show|Просмотреть содержимое очереди|
|seq pulse [...]|Добавить импульс в конец очереди; порядок аргументов схож с basic_pulse|
|seq sweep [...]|Добавить ЛЧМ сигнал в конец очереди; порядок аргументов схож с basic_sweep|
|seq json [...]|Добавить сложный сигнал на основе JSON-дескриптора в конец очереди|

**СИСТЕМНЫЕ КОМАНДЫ** 

|**Команда**|**Пояснение**|
|---|---|
|isr|Просмотреть статистику прерываний процессора|
|mem|Просмотреть статистику использования и фрагментации памяти|
|perf|Просмотреть статистику ввода/вывода и прочих событий|
|reboot|Перезагрузить генератор|

**ПРОЧИЕ КОМАНДЫ** 

|**Команда**|**Пояснение**|
|---|---|
|wait|Перейти в режим следования за регистрирующим комплексом. В данном режиме генератор ожидает старта регистрирующего комплекса, после чего запускает воспроизведение. Подключение к генератору переходит в неинтерактивный режим отправки телеметрии. Выход из данного режима осуществляется разрывом подключения к генератору.|

**ДОПОЛНЕНИЕ: ПОЛОСА ЛЧМ СИГНАЛОВ**

Параметры a и b для ЛЧМ сигналов являются целыми числами, представляющими машинные коды для блока генерации ЛЧМ в AD9910. Полоса ЛЧМ сигнала в Гц выражается на основе данных параметров совместно с длительностью сигнала:

```
steps = duration * 250 MHz / b
band = a * (1 GHz / 2^32) * (steps - 1)
```

|Параметр|Значение|
|---|---|
|duration|Длительность сигнала в секундах|
|a|Величина шага в единицах FTW|
|b|Делитель частоты шагов|

Когда a положительное, частота ЛЧМ сигнала нарастающая, то есть конечная частота выше начальной. Если a отрицательное, то частота ЛЧМ будет убывающая, когда конечная частота ниже начальной.

Вот некоторые возможные комбинации a и b:

|duration|a|b|Полоса|
|---|---|---|---|
|18000 us|1|1|~1.04773 MHz|
|900 us|1|1|~52.386 kHz|
|900 us|10|1|~0.52386 MHz|
|900 us|20|1|~1.04773 MHz|

## Внутреннее строение

![Структурная схема генератора тестовых сигналов](Images/signal_generator.drawio.pdf)

В состав генератора сигналов входит:

- Блок питания, создающий напряжение 5V
- Микроконтроллерная плата Nucleo F746ZG
- Плата-переходник, выводящая управляющие сигналы с микроконтроллера и создающая напряжения 3.3V и 1.8V
- Плата с синтезатором AD9910
- Усилитель, выполняющий защитную роль

Усилитель необходим, чтобы защитить синтезатор от излучения, которое может присутствовать на выходе генератора во время работы передатчиков станции. Генератор предусматривает подключение к приемному тракту на постоянной основе через входы/выходы системы фазирования, которые обладают встроенным ослаблением примерно в 5000 раз; уровень сигнала в них во время излучения передатчиков составляет примерно 5 вольт.

> FIXME: команда `set_level` выставляет уровень именно на выходе синтезатора. После усилителя уровень примерно в 1.3 раза больше.

# Утилиты управления и анализа данных

Набор утилит управления и анализа данных предназначен для организации процесса диагностики приемного тракта станции. В его состав входят программные инструменты для управления генератором сигналов и штатным регистрирующим комплексом на этапе сбора данных, а также утилиты для оценки характеристик на основе полученных данных.

**УТИЛИТЫ**

|**Название**|**Пояснение**|
|---|---|
|c2.py|На основе диагностического шаблона организует пропускание последовательностей тестовых сигналов через тракт|
|mksweep.py|Генерирует диагностические шаблоны с ЛЧМ сигналами на сетке частот|
|phase_delta.py|Выполняет оценку разности фаз между каналами|
|amplitude_response.py|Выполняет оценку АЧХ|
|phase_response.py|Выполняет оценку ФЧХ|

## Развертывание

Утилиты взаимодействуют со штатным ПО регистрирующего комплекса и поэтому предполагают развертывание в среде регистрирующего комплекса, а не на отдельной машине.

Для работы утилит необходим интерпретатор Python. Поскольку регистрирующий комплекс работает Windows 7, официальные сборки новых версий установить не получится из-за прекращения поддержки данной ОС. Необходимо использовать сборку от сообщества, в которой восстановлена совместимость: [https://github.com/adang1345/PythonWin7.](https://github.com/adang1345/PythonWin7)

Также необходимы библиотеки numpy и plotly, которые можно установить, выполнив `py -m pip install numpy plotly` в командной строке.

Далее требуется скачать репозиторий с утилитами и расположить его в обозначенном месте на файловой системе.

**РАЗМЕЩЕНИЕ НА ДИСКЕ**

|**Директория**|**Содержимое**|
|---|---|
|c:/workprogs/calibrator_software|Набор утилит управления и анализа|
|c:/workprogs/calibrator_mode|Отдельная копия штатного ПО регистрирующего комплекса, предназначенная специально для проведения диагностических измерений|
|c:/calibrator-data-v1|Поддиректории с данными, накопленными в процессе измерений|

В директорию `c:/workprogs/calibrator_mode` необходимо скопировать следующие файлы от штатного ПО регистрирующего комплекса:

```
brd.ini
dsp.exe
frequency2.cfg
phase_table.cfg
radar_config.ini
spu_modes.cfg
```

Также необходимо создать файл `c:/DDC4_Settings/test_cal.ini` со следующим содержимым:

```
[Option]
TestMode= 0
SamplesPerChannel= 8192
IsSystemMemory=1
ClockSource= 0x81
ClockValueInt= 200000000
ClockValueExt= 200000000
DataSource= 1
DecimCiC= 10
Outmode= 28
AdcCh0= 0
AdcCh1= 1
AdcCh2= 2
AdcCh3= 3
Fc0= 158000000
Fc1= 158000000
Fc2= 158000000
Fc3= 158000000
MaskChan= 0xa
StartSrc= 7
StartInv= 1
StartLevel= 1.0
StartResist= 0
MaskFlt= 0xa
FirFilter= C:\DDC4_Settings\f256_d4_b25_full_seldna_5.coe
```

Данные параметры сконфигурируют программу регистрирующего комплекса создавать реализации с частотой дискретизации 5 МГц и содержащие 8192 выборки.

> Примечание: возможно, директории с записями и копию штатного ПО следует разместить на общем сетевом диске --- это позволило бы запускать утилиты на отдельной от регистрирующего комплекса машине.

# Проведение диагностических измерений

## Предварительная проверка непрерывным сигналом

Перед выполнением измерений следует удостовериться, что сигналы, подаваемые генератором в приемный тракт, достигают входов регистрирующего комплекса и воспринимаются им. Это позволяет исключить ряд возможных проблем, касающихся подключения генератора к приемному тракту.

Генератор сигналов должен быть подключен к приемному тракту через отмеченный тремя полосками кабель, который затем идёт в антенный зал, где разветвляется на два канала и отходит к резервным портам системы фазирования на антенном коммутаторе.

![Схема подключения генератора сигналов к приемному тракту](Images/signal_injection.drawio.pdf)

Генератор сигналов и регистрирующий комплекс также должны быть подключены к общей локальной сети и к одному триггерному сигналу.

Чтобы убедиться в том, что тестовые сигналы поступают в приемный тракт, удобнее всего использовать непрерывный сигнал --- он будет полностью заполнять окно записи вне зависимости от положения окна во времени.

Нужно определиться с частотой сигнала и отредактировать таблицу частот в файле frequency2.cfg в директории с диагностической копией ПО регистрирующего комплекса (c:/workprogs/calibrator_mode), чтобы она имела одну строку вида:

```
157000 155000 10 900 0 2150 0
```

Где второе значение --- выбранная частота в кГц.

После чего следует сделать следующее:

1. проверить, что передатчики станции отключены и управляющая программа регистрирующего комплекса закрыта;
2. запустить управляющую программу `c:/workprogs/calibrator_mode/dsp.exe`;
3. нажать start и открыть визуализацию (кнопка "graphics");
4. подключиться к генератору сигналов через netcat или putty и выполнить команды:
	- `set_level 250 mV`
	- `test_tone 155.01 MHz`
		- где 155.01 MHz это выбранная частота со смещением на 0.01 МГц;

На визуализации должно быть видно форму волны смещенного с центральной частоты сигнала.

После подтверждения наличия сигнала следует выполнить на генераторе команду `rfkill`, чтобы прекратить излучение, и закрыть подключение к генератору.

## Изменение разности фаз между каналами (и АЧХ)

В такой же аппаратной конфигурации можно произвести измерение разности фаз между каналами в зависимости от частоты сигнала.

Чтобы покрыть весь рабочий диапазон частот станции, данное измерение необходимо выполнять в режиме сканирования частот. В качестве тестового сигнала следует использовать повторяющиеся на разных частотах ЛЧМ импульсы --- так можно покрыть целую полосу частот в каждой реализации, однако полоса должна вмещаться в полосу пропускания фильтров регистрирующего комплекса.

Первым делом следует сгенерировать диагностический шаблон для утилиты c2.py, что делается при помощи утилиты mksweep.py:

```
py mksweep.py --start "154 MHz" --stop "162 MHz" --step "0.25 MHz" --delay "500 us" --duration "900 us" --a 10 --b 1 --level "250 mV" > presets/operation_band_sweep.json
```

**ПАРАМЕТРЫ MKSWEEP.PY**

|**Аргумент**|**Пояснение**|
|---|---|
|`--start "154 MHz"`|Начальная частота сетки частот|
|`--stop "154 MHz"`|Конечная частота сетки частот|
|`--step "0.25 MHz"`|Шаг сетки частот|
|`--delay "500 us"`|Задержка внутри окна записи --- желательно отодвинуть импульс от начала окна, поскольку в начале могут присутствовать помехи. Важно, чтобы в сумме задержка и длительность импульса вмещались в окно записи; когда $F_s$ = 5 МГц, а $N$ = 8192, длительность окна составляет 1638.4 мкс.|
|`--duration "900 us"`|Длительность импульса|
|`--a 10 --b 1`|Параметры ЛЧМ, которые совместно с длительностью определяют полосу. В данном случае полоса составит ~523.9 кГц.|
|`--level "250 mV"`|Уровень сигналов|

Данная команда сгенерирует JSON-документ, который описывает последовательность из 33 ЛЧМ импульсов, частично перекрывающих друг друга по частоте, и сохранит его в файл `presets/operation_band_sweep.json`

Далее следует:

1. убедиться что передатчики выключены и `dsp.exe` закрыта;
2. в командной строке вызвать утилиту `c2.py` с указанием пути к диагностическому шаблону: `py c2.py presets/operation_band_sweep.json`;
	- в директории для сохранения данных будет создана новая поддиректория для текущего сеанса диагностики;
	- будет сгенерирована новая таблица частот и общая конфигурация для `dsp.exe`
	- очередь генератора сигналов будет наполнена импульсами из диагностического шаблона;
	- генератор начнёт ожидать старта регистрирующего комплекса;
	- утилита выведет приглашение начать запись в программе регистрирующего комплекса;
3. запустить `c:/workprogs/calibrator_mode/dsp.exe`;
4. нажать "write" затем "start".

После нажатия на кнопку "start" регистрирующий комплекс и генератор сигналов начнут синхронное зацикленное продвижение по таблице частот и последовательности импульсов. Генератор сигналов будет следовать за регистрирующим комплексом, ожидая подтверждения каждого триггера по сети и при необходимости повторяя импульсы, если регистрирующий комплекс по какой-то причине пропустил один из стартов.

В окне командной строки начнет отображаться телеметрия от генератора сигналов, которая представляет собой поток привязанных ко времени событий:

- Готовность к излучению очередного импульса
- Получение триггера
- Получение подтверждения от DDC (Регистрирующего комплекса)

Когда будет накоплено достаточно данных, следует:

1. остановить запись в программе регистрирующего комплекса, затем нажать "stop";
2. в окне командной строки с утилитой c2.py нажать Ctrl+C затем Enter;
	- генератор сигналов остановится после закрытия c2.py.

На этом сеанс диагностики завершается.

Вывести график разности фаз на основе полученных данных можно следующей командой:

```
py phase_delta.py --location "c:/calibrator-data-v1/..." --channels 1,3
```

Где `c:/calibrator-data-v1/...` это путь к последней поддиректории с данными, а `--channels 1,3` указывает, между какими каналами вычислить разность фаз.

> Примечание: здесь каналы нумеруются с нуля.

Также можно построить график АЧХ (без поправки на собственные характеристики средств измерений):

```
py amplitude_response.py --dut "c:/calibrator-data-v1/..." --raw
```
