## Команды в текстовом интерфейсе

### set_level [level]

Установить уровень сигнала в единицах амплитуды (ASF) синтезатора от 0 до 16383. По умолчанию установлено значение 1024. Новое значение применяется только к заданным далее сигналам, старые сигналы в секвенсоре не затрагиваются.

Когда [значение регистра FSC](https://github.com/AXKuhta/stm32_ad9910/blob/cc35445c1cfcc48be5461d00f6e6bd2841d0e761/ad9910/init.c#L61) = 127, то ASF = 16383 соответствует уровню примерно 130 mV и уровень масштабируется линейно, т.е. значение 8192 будет равно уровню примерно 70 mV.

Пример: `set_level 16383`

Ниже представлены реально измеренные анализатором спектра значения при ASF = 16383:

|Freq|FSC|Уровень|
|---|---|---|
|2 MHz  |255|253 mV|
|20 MHz |255|247 mV|
|100 MHz|255|214 mV|
|154 MHz|255|206 mV|
|158 MHz|255|206 mV|
|162 MHz|255|209 mV|

|Freq|FSC|Уровень|
|---|---|---|
|2 MHz  | 127| 160 mV|
|20 MHz | 127| 156 mV|
|100 MHz| 127| 135 mV|
|154 MHz| 127| 130 mV|
|158 MHz| 127| 130 mV|
|162 MHz| 127| 132 mV|

|Freq|FSC|Уровень|
|---|---|---|
|2 MHz  | 0| 68 mV|
|20 MHz | 0| 67 mV|
|100 MHz| 0| 58 mV|
|154 MHz| 0| 56 mV|
|158 MHz| 0| 56 mV|
|162 MHz| 0| 57 mV|

### test_tone [freq] [unit]

Подача непреревного сигнала на указанной частоте.

Пример: `test_tone 159.0 MHz`

![test_tone 159 MHz](https://github.com/AXKuhta/stm32_ad9910/assets/11133304/b8247705-0dce-4c52-bee0-04f8d200ca63)

### basic_pulse [offset] [unit] [duration] [unit] [freq] [unit]

Подача импульсов некоторой длительности на некоторой частоте, с некоторым отступом от триггера.

Пример: `basic_pulse 0 us 18000 us 159.0 MHz`

![basic_pulse 0 us 18000 us 159 MHz](https://github.com/AXKuhta/stm32_ad9910/assets/11133304/811c9247-69cc-470e-939c-28d8a6da24cb)

### basic_sweep [offset] [unit] [duration] [unit] [center_freq] [unit] [a] [b]

Свипы некоторой продолжительности, с некоторым отступом от триггера, на некоторой центральной частоте, с некоторой общей полосой.

|Параметр|Значение|
|---|---|
|a|Величина шага в единицах FTW|
|b|Делитель частоты шагов|

Полоса вычисляется следующим образом:

```
steps = duration * 250 MHz / b
band = a * (1 GHz / 2^32) * (steps - 1)
```

Если a положительное, то направление свипа будет нарастающее, т.е. начальная частота свипа будет ниже конечной частоты. Если же a отрицательное, то направление свипа будет убывающим, когда начальная частота выше конечной частоты.

Пример свипа с положительным a: `basic_sweep 0 us 18000 us 159.0 MHz 1 1`

![basic_sweep 0 us 18000 us 159 0 MHz 1 1](https://github.com/AXKuhta/stm32_ad9910/assets/11133304/42b9fbb8-24d8-41ef-bb70-10d8a34ef350)

Привер свипа с отрицательным a: `basic_sweep 0 us 18000 us 159.0 MHz -1 1`

![basic_sweep 0 us 18000 us 159 MHz -1 1](https://github.com/AXKuhta/stm32_ad9910/assets/11133304/dad0410a-4e60-432f-98e3-4a42e0b2e1b7)

Вот некоторые возможные комбинации a и b:

|duration|a|b|Полоса|
|---|---|---|---|
|18000 us|1|1|~1.04773 MHz|
|900 us|1|1|~52.386 kHz|
|900 us|10|1|~0.52386 MHz|
|900 us|20|1|~1.04773 MHz|

Можно получить значения с меньшим количеством знаков после запятой, если использовать длительность, равную степени двойки + 4ns:

|duration|a|b|Полоса|
|---|---|---|---|
|2^20ns + 4ns|128|1|7.8125 MHz|
|2^20ns + 4ns|256|1|15.625 MHz|
|2^20ns + 4ns|512|1|31.25 MHz|

Также допустимо создание свипов с очень маленьким количеством шагов. Например, свип с величиной шага a = 42949673 (Примерно 10 МГц), делителем частоты шагов b = 22500, длительностью 900 мкс и центральной частотой 150 МГц будет содержать всего десять частотных составляющих, каждая длительностью 90 мкс:

```
1  105 МГц
2  115 МГц
3  125 МГц
4  135 МГц
5  145 МГц
6  155 МГц
7  165 МГц
8  175 МГц
9  185 МГц
10 195 МГц
```

## basic_xmitdata ram_psk [offset] [unit] [freq] [unit] [element_duration] [unit] [...]

Подача импульсов с BPSK модуляцией с использованием оперативной памяти AD9910.

Максимальная длительность элемента составляет 4 / (1 GHz) * 65535 = ~262мкс. Если нужно больше, то можно составить два или более одинаковых элемента друг за другом.

Общая продолжительность сигнала определяется исходя из количества элементов и длительности одного элемента.

Элементы кода записываюся после основной команды и могут быть равны 0 либо 1, где 0 - нет сдвига фазы, а 1 - фаза сдвинута на 180 градусов.

Максимальное количество элементов в коде составляет 1023. Всего оперативная память AD9910 может вместить 1024 элемента, но последний элемент зарезервирован для прерывания сигнала.

Пример: `basic_xmitdata ram_psk 0 us 159.0 MHz 200 us 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0`

![basic_xmitdata ram_psk 0 us 159 0 MHz 200 us 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0](https://github.com/AXKuhta/stm32_ad9910/assets/11133304/9d44b6c3-7886-439b-b150-7b878d2c6e5a)

## seq [...]

Команды секвенсора позволяют задавать последовательности из разных сигналов. При воспроизведении последовательность в секвенсоре повторяется бесконечно.

|Команда|Пояснение|
|---|---|
|seq pulse [...]|Добавить сигнал с фиксированной частотой в конец очереди; порядок аргументов идентичен basic_pulse|
|seq sweep [...]|Добавить свип в конец очереди; порядок аргументов идентичен basic_sweep|
|seq run|Запустить воспроизведение|
|seq stop|Остановить воспроизведение|
|seq reset|Очистить очередь|

Пример:

```
seq sweep 0 us 18000 us 159.0 MHz 1 1
seq pulse 0 us 18000 us 159.524 MHz
seq sweep 0 us 18000 us 159.0 MHz -1 1
seq pulse 0 us 18000 us 158.476 MHz
seq run
```

![sequencer](https://github.com/AXKuhta/stm32_ad9910/assets/11133304/f3c8a885-f8eb-494d-8bab-78471956a0b9)
